<!DOCTYPE html>
<html>
  <head>
      
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->

  <link rel="stylesheet" href="/nycko-pages/css/main.css">
  <link rel="canonical" href="http://localhost:4000/nycko-pages/c++/Jni.html">
  <link rel="alternate" type="application/rss+xml" title="Nycko Blog" href="http://localhost:4000/nycko-pages/feed.xml">

<!-- Google font -->

  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Noto Sans">

<!-- font awesome -->

<link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">

</head>


  

  

  </head>

  <body>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>JNI的基本使用</title>
  <meta name="description" content="  各种理论，jni和jna对比等，请自行百度，这里仅介绍一下基本使用方法，方便初学者，也给自己留一份笔记而已。  介绍jni的使用流程  示例了java中string和byte[]与c++的类型转换，以及容易忽略的内存泄漏问题  简单介绍了native方法定义为static的相关问题">
</head>


  <div class="wrapper">
          <header class="post-header">

    <center><div class="post-title" itemprop="name headline">JNI的基本使用</div>

		<div class="post-meta"><i class="fa fa-calendar-o"></i> <time datetime="10 May 2018" itemprop="datePublished">May 10 2018</time>

		
		<br>
		<i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-pulse"></i></span>˚C</span>
	</div>

        
        <div class="post-tags">
        
		<a class="post-tags-item" href="http://localhost:4000/nycko-pages/tags/">JAVA</a>
        
		<a class="post-tags-item" href="http://localhost:4000/nycko-pages/tags/">Common</a>
        
		<a class="post-tags-item" href="http://localhost:4000/nycko-pages/tags/">C++</a>
        
	</div>
    </center>
    
</header>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content">
    <center>
	
	<p>JAVA与C/C++沟通的桥梁</p>
	
    </center>
	<h2>Directory</h2>
</div>

<div id="category"></div>

<div class="post-content" itemprop="articleBody">
    <ul>
  <li>各种理论，jni和jna对比等，请自行百度，这里仅介绍一下基本使用方法，方便初学者，也给自己留一份笔记而已。</li>
  <li>介绍jni的使用流程</li>
  <li>示例了java中string和byte[]与c++的类型转换，以及容易忽略的内存泄漏问题</li>
  <li>简单介绍了native方法定义为static的相关问题</li>
</ul>

<h1 id="使用流程">使用流程</h1>
<p>简单说一下jni的使用流程就像一个圆，从java出发，声明你需要的native方法，生成一个对应的.h文件，根据这个h文件构造c/c++工程生成dll/so动态库，最后返回来给java调用。</p>
<h2 id="1--java-class">1 : java class</h2>
<p>src/jni/LibTest.java:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">LibTest</span> <span class="p">{</span>
    <span class="k">static</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="s">"jni_lib_LibTest"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">native</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">HelloWorld</span><span class="p">(</span><span class="n">String</span> <span class="n">i_instr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>src/JniTest.java:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">JniTest</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LibTest</span><span class="p">.</span><span class="n">HelloWorld</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="s">"I'm Nycko"</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>到这里java的代码可以说是全部写完了，当main方法执行时，将调用LibTest的HelloWorld方法，该方法的实现来自于jni_lib_LibTest.dll(libjni_lib_LibTest.so)中，那么这个工程现在缺少的就是这个c++动态库了，下面来生成这个动态库。</p>

<h2 id="2--dllso">2 : dll/so</h2>

<p>无论是windows还是linux，你需要确保命令行可以运行javac，不行的自行百度安装jdk并且设置环境变量。</p>
<ul>
  <li>
    <p>在定义native的.java文件目录下用javac编译该文件获得.class文件。<br />
cd src/jni/<br />
javac LibTest.java</p>
  </li>
  <li>
    <p>然后前往该项目的源码目录，用javah处理刚才生成的.class文件，这里javah后面跟的不是路径，而是java中的包名+类名(注意一下命令与文件路径(src/jni/LibTest.java)的关系)<br />
cd src/<br />
javah jni.LibTest</p>
  </li>
  <li>
    <p>生成了一个.h文件，该文件官方说法是建议不要修改的，然后根据这个.h文件构建一个c/c++工程生成对应的动态库。<br />
jni_lib_LibTest.h：</p>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="cp">#include &lt;jni.h&gt;
</span><span class="cm">/* Header for class jni_lib_LibTest */</span>

<span class="cp">#ifndef _Included_jni_lib_LibTest
#define _Included_jni_lib_LibTest
#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#endif
</span><span class="cm">/*
 * Class:     jni_lib_LibTest
 * Method:    HelloWorld
 * Signature: (Ljava/lang/String;)V
 */</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span> <span class="n">Java_jni_1lib_LibTest_HelloWorld</span>
  <span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jstring</span><span class="p">);</span>

<span class="cp">#ifdef __cplusplus
</span><span class="p">}</span>
<span class="cp">#endif
#endif
</span></code></pre></div></div>

<ul>
  <li>编写对应c/cpp文件，jni_lib_LibTest.cpp：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "jni_lib_LibTest.h"
#include &lt;iostream&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span> <span class="nf">Java_jni_1lib_LibTest_HelloWorld</span>
<span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">j_i_inStr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">i_inStr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">j_i_inStr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i_inStr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"i_inStr == NULl!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"OutPut in jni_lib_LibTest.cpp!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Helloworld! i_inStr is : "</span> <span class="o">&lt;&lt;</span> <span class="n">i_inStr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseStringUTFChars</span><span class="p">(</span><span class="n">j_i_inStr</span><span class="p">,</span> <span class="n">i_inStr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>编译成动态库<br />
某些系统会出现找不到jni.h和jni_md.h你需要把路径加入编译选项<br />
视情况加入：-I $(JAVA_HOME)/include/   <br />
视情况加入：-I $(JAVA_HOME)/include/linux（jni_md.h一般再include子目录下找一下就能找到了）<br />
g++ -shared -o libjni_lib_LibTest.so jni_lib_LibTest.cpp</li>
</ul>

<h2 id="3--java加载jni_lib_libtestdll--libjni_lib_libtestso">3 : java加载jni_lib_LibTest.dll / libjni_lib_LibTest.so</h2>
<ul>
  <li>把这个.dll(.so)动态库放到合适的地方，可以是系统默认库目录，也可以通过设置LD_LIBRARY_PATH的值实现，更多关于找不到库的问题需要视乎不同系统，不同平台，不同ide区分解决办法，这里不详细描述<br />
System.loadLibrary(“jni_lib_LibTest”); //注意文件名与库名的对应规则</li>
  <li>同样你也可以使用绝对路径来加载：如<br />
System.load(“/home/nycko/libjni_lib_LibTest.so”);</li>
  <li>运行java程序，输出如下：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">OutPut</span> <span class="n">in</span> <span class="n">jni_lib_LibTest</span><span class="p">.</span><span class="n">cpp</span><span class="o">!</span>
<span class="n">Helloworld</span><span class="o">!</span> <span class="n">i_inStr</span> <span class="n">is</span> <span class="o">:</span> <span class="n">I</span><span class="err">'</span><span class="n">m</span> <span class="n">Nycko</span>
</code></pre></div></div>
<h1 id="介绍两个常用的类型转换">介绍两个常用的类型转换</h1>
<p>关于jni的内存管理，在这里不做详细描述，提供几个关键词进行搜索：<br />
Heap Memory/Native Memory/LocalReference/GlobalReference/Weak Global Reference<br />
目前个人简单理解是：除了使用JNIEnv方法创建的，然后return给java的对象以外，其他的都需要进行内存的释放，最基础的使用是java层入参，如：GetStringUTFChars把jstring类型转换成char*后，务必使用ReleaseStringUTFChars进行释放</p>
<ul>
  <li>string获取:<br />
获取传入参数String：jstring java_string</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span><span class="o">*</span> <span class="n">str_cpp</span> <span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">java_string</span><span class="p">,</span> <span class="nb">false</span><span class="p">));</span> 
<span class="k">if</span><span class="p">(</span><span class="n">str_cpp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//do something</span>
<span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseStringUTFChars</span><span class="p">(</span><span class="n">java_string</span><span class="p">,</span> <span class="n">str_cpp</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>srting返回：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"nycko"</span><span class="p">;</span>
<span class="c1">//do something</span>
<span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>  
</code></pre></div></div>
<ul>
  <li>byte[]获取：<br />
获取jbyteArray java_byte</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">byte_len</span><span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">java_byte</span> <span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">byte_value</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetByteArrayElements</span><span class="p">(</span><span class="n">java_byte</span> <span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="c1">//do something</span>
<span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseByteArrayElements</span><span class="p">(</span><span class="n">java_byte</span><span class="p">,</span> <span class="p">(</span><span class="n">jbyte</span><span class="o">*</span><span class="p">)</span><span class="n">byte_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
</code></pre></div></div>
<ul>
  <li>byte[]返回：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="kt">int</span> <span class="n">byte_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
     <span class="n">BYTE</span><span class="o">*</span> <span class="n">byte_value</span><span class="o">=</span><span class="k">new</span> <span class="n">BYTE</span><span class="p">[</span><span class="mi">10</span><span class="p">]();</span>
     <span class="n">jbyteArray</span> <span class="n">jarrRV</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewByteArray</span><span class="p">(</span><span class="n">byte_len</span><span class="p">);</span>
     <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetByteArrayRegion</span><span class="p">(</span><span class="n">jarrRV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byte_len</span> <span class="p">,</span> <span class="p">(</span><span class="n">jbyte</span><span class="o">*</span><span class="p">)</span><span class="n">byte_value</span><span class="p">);</span>
     <span class="k">return</span> <span class="n">jarrRV</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="关于java中native方法是否定义为static的问题">关于java中native方法是否定义为static的问题：</h1>

<ul>
  <li>定义为static的方法不需要创建该类的实例就能调用，对应生成的.h文件第二个参数是jclass类型，由于不是实例，所以估计（java基础不足只能说估计）如果要在c++上使用这个参数也只能调用到同是static的其他成员变量或者方法</li>
  <li>非static方法需要先创建该类的实例才可以通过该实例调用，对应.h文件是第二个参数是jobject类型，是调用该方法的实例对象，可以用该变量在c++获取java该对象的其他成员</li>
  <li>所以，如果修改了java工程中相关定义，记得要根据新生成的.h文件来修改.c/.cpp文件，这个类型一定要对上</li>
</ul>


</div>

<div>
	
	<div class="tbc"></div>
	
</div>

<div class="share">
    <p>Share this post with: </p>
	<a href="https://twitter.com/intent/tweet?text=JNI的基本使用@&amp;url=http://localhost:4000/nycko-pages/c++/Jni.html" class="twitter-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/nycko-pages/c++/Jni.html" class="facebook-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://plus.google.com/share?url=http://localhost:4000/nycko-pages/c++/Jni.html" class="googleplus-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</span>
	</a>
</div>


<div id="disqus_thread"></div>


 
</div>


</article>

  </div>

</body>

<foot>

    <footer class="site-footer">

  <div class="wrapper">

    <center>
        
		<p><a class="link" href="/nycko-pages/archive/">Archive</a> /
		<a class="link" href="/nycko-pages/category/">Category</a> / 
		<a class="link" href="/nycko-pages/tags/">Tags</a> / 
		<a class="link" href="/nycko-pages/about/">About</a> /
		<a class="link" href="/nycko-pages/contact/">Contact</a>
        </p>

        <span><script>document.write(new Date().getFullYear());</script></span>
        <span>&copy;</span>
        
		<a class="link" href="/nycko-pages">Nycko Blog</a>
		<br>
		<span>Theme &copy; <a class="link" href="https://gabriel-chen.github.io" target="_blank"> Gabriel</a> | </span>
				<iframe
			style="margin-left: 2px; margin-bottom:-5px;"
			frameborder="0" scrolling="0" width="91px" height="20px"
			src="https://ghbtns.com/github-btn.html?user=itisbenjamin&repo=Nice_Blog&type=star&count=true" >
		</iframe>

    </center>
    
  </div>

</footer>

    <foot>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Derictory -->

  <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script src="https://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<!-- Hit analytics -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Directory -->

<script src="/nycko-pages/js/main.js"></script>

</foot>


</foot>

</html>
